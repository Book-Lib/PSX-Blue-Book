# Расширенная библиотека карт памяти

# Обзор

Библиотека карт памяти высокого уровня (libmcrd) предоставляет удобный интерфейс для использования карт памяти, установленных в PlayStation.

## Библиотека и заголовочные файлы

Программы, использующие расширенные службы библиотеки карт памяти, должны быть связаны с файлом libmcrd.lib. Внутри libmcrd используются libcard.lib и libapi.lib, поэтому эти библиотеки также необходимо связать.

Исходные файлы должны включать заголовочный файл libmcrd.h.

## Особенности библиотеки

- Проверьте наличие карты памяти, проверьте, не инициализирована ли карта памяти, и проверьте недействительность карты памяти.
- Запись данных на карту памяти.
- Чтение данных с карты памяти.
- Логическая инициализация (форматирование) карты памяти.
- Удаление файла
- Создание файла
- Получить информацию о каталоге

## Проверка состояния карты памяти

Карту памяти можно вставлять и извлекать, когда PlayStation включена. Таким образом, пользовательское приложение должно быть разработано с учетом того факта, что карту памяти можно вставить или извлечь в любое время.

Libmcrd предоставляет функцию MemCardAccept(), позволяющую определить, была ли карта вставлена или удалена. Статус карты можно получить с помощью этой функции, когда карта установлена.


## Чтение/запись данных

При записи или чтении данных на карту памяти могут возникнуть ошибки связи. Libmcrd внутренне выполняет повторные попытки, когда возникают ошибки связи во время чтения или записи данных. Однако записанные или прочитанные данные должны быть проверены пользовательским приложением с использованием процесса проверки, контрольной суммы или другого метода, чтобы убедиться в их правильности.

## Обнаружение новой карты

Только что вставленная карта памяти считается новой картой. Поскольку новая карта может быть неотформатированной или недействительной, библиотека устроена так, что к карте невозможно получить доступ, пока не будет выполнен MemCardAccept().

Однако если новая карта была обнаружена с помощью MemCardAccept(), нет необходимости снова выполнять MemCardAccept(), поскольку различные процессы, такие как проверка формата, уже были выполнены.

Если вставлена новая карта, любая функция, отличная от MemCardAccept() (например, MemCardExit() или MemCardReadFile()), вернет в качестве результата «Обнаружена новая карта», независимо от того, сколько раз она вызывается.

# Libcard и BIOS карты

Libmcrd использует функции и ресурсы libcard и BIOS карты, такие как события HwCARD и SwCARD.

Следовательно, пользовательские приложения не могут напрямую использовать libcard или BIOS карты.

Если пользовательскому приложению необходимо выполнить операцию, которую невозможно реализовать с помощью libmcrd, приложение должно реализовать все операции с картой памяти, которые используют libcard и BIOS карты.

# Используйте с Multi Tap

При переключении доступа между несколькими картами памяти, подключенными к одному Multi Tap, вызывайте MemCardAccept() каждый раз, когда вы получаете доступ к другой карте памяти. Причина этого в том, что в libmcrd каждый порт устройства PlayStation имеет только один буфер информации о каталоге. Когда к одному Multi Tap подключено несколько карт памяти, можно управлять информацией только одного каталога.

# Карта памяти

Карта памяти — это устройство хранения данных, на котором сохраняются данные даже после выключения или перезагрузки PlayStation.

Карты памяти можно вставлять и извлекать, когда PlayStation включена.

## Аппаратное обеспечение

Технические характеристики оборудования карты памяти приведены ниже.

**Таблица 6-1: Технические характеристики карты памяти**

|Параметр|Описание|
|-------|---------|
|Емкость|120 Кбайт (отформатированный) (Доступ осуществляется в секторах по 128 байт)|
|Коммуникация|Синхронный последовательный порт, также служащий портом контроллера.|
|Скорость доступа|(1) Нет доступа в течение 20 мс после записи одного сектора.|
| |(2) Максимальная скорость непрерывного чтения примерно 10 Кбайт/сек.|
|Другой|Можно вставлять и вынимать без выключения питания.|
| |Гарантия на 100 000 записей.|

# Правила использования карты памяти

Карта памяти — это ресурс, который используется несколькими приложениями. Поэтому карту памяти следует использовать в соответствии с общими правилами.

## Обработка неровностей

Не требуется вывод экрана или сообщения, когда на карте во время выполнения приложения заканчивается память или когда обнаруживается неотформатированная карта (т. е. не требуется, чтобы отображение было таким же, как экранное меню). Скорее, эти ситуации можно настроить в соответствии с приложением. Тем не менее, следует принять во внимание следующие моменты.

- Пользователь должен быть уведомлен перед форматированием. Форматирование не должно выполняться автоматически.
- Пользователь должен быть уведомлен, если карта не обнаружена, но ожидается. Если возможно, пользователю должно быть предложено вставить карту.

## Терминология

В каталогах продукции необходимый объем памяти выражается в «блоках», где размер одного блока составляет 8192 байта.

## Имена файлов

Имена файлов должны быть присвоены следующим образом:

**Таблица 6-2: Имена файлов на карте памяти**


|Байт|Описание|Примечания|
|----|--------|----------|
|0|Магическое число|Всегда «B»|
|1|Регион|«I» для Японии, «A» для Северной Америки, «E» для Европы (\*1)|
|2-11|Заголовок|Номер продукта SCE (*2)|
|12-20|Определяемые пользователем|Используйте символы ASCII, за исключением 0x00, 0x2a («\*»), 0x3f («?»).Заканчивается на 0x00|

\*1: Не проверяется системой.
\*2: Если заголовок состоит из нескольких дисков, используйте номер продукта с первого диска.

Номер продукта SCE будет определен на предварительном собрании по продажам, проводимом нами (примерно за три недели до подачи мастер-класса), и мы уведомим об этом деловое контактное лицо рассматриваемой компании. Пожалуйста, используйте номер продукта следующим образом.
Например, если код продукта «SLPS-00001»,
Первые 12 символов имени файла будут BASLPS-00001».
Числовая часть должна состоять из пяти цифр, дополненных нулями.

## Заголовок файла

Пожалуйста, используйте следующий заголовок в начале каждого файла:

**Таблица 6-3: Заголовок файла карты памяти**

|Элемент|Размер (байты)|
|-------|--------------|
|Магическое число|2 (всегда «SC»)|
|Тип (см. таблицу 6-4)|1|
|Количество блоков|1|
|Имя|64 (Shift-JIS \*1)|
|pad|28 (все упаковано в 0x00)|
|Clut|32|
|Изображение значка (1)|128 (16x16x4 бита)|
|Изображение значка (2)|128 (только тип==0x12, 0x13)|
|Изображение значка (3)|128 (только тип==0x13)|
|Данные|Переменная (128 байт x n)|

\*1: Только кандзи, не являющиеся кандзи, и кандзи уровня 1. 

Полная ширина, 32 символа. Однако адреса от 0x84bf до 0x889e использовать нельзя.
 
Конец строки символов заканчивается в 0x00.


**Таблица 6-4: Поле типа**

|Тип|Количество изображений значков(Анимация через автоматическую замену)|
|---|--------------------------------------------|
|0x11|1|
|0x12|2|
|0x13|3|	  

## Сохранение данных записи

Приложение должно обрабатывать случаи, когда данные уничтожаются из-за перезагрузки устройства, удаления карты или отключения питания во время операции записи данных.

Чтобы сохранить данные: Запишите данные дважды, записывая в один набор данных, а затем в другой. В конце каждого сектора добавьте контрольную сумму для сектора. Проведите проверку контрольной суммы при чтении секторов. Если обнаружена ошибка, используйте другой набор данных.

Внимание: Функция замены сектора файловой системы действительна только в случае ошибок записи в память карты памяти. Не существует аппаратной или библиотечной поддержки для сохранения содержимого записываемых данных.